<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>漏洞检测中心 - 二进制分析平台</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#00C853',
            accent: '#7B61FF',
            dark: '#1D2939',
            light: '#F9FAFB',
            sidebar: {
              bg: '#1530a0',
              hover: 'rgba(255, 255, 255, 0.18)',
              active: 'rgba(255, 255, 255, 0.25)'
            }
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .text-shadow {
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .text-gradient {
        background-clip: text;
        -webkit-background-clip: text;
        color: transparent;
      }
      .bg-glass {
        backdrop-filter: blur(10px);
        background-color: rgba(255, 255, 255, 0.7);
      }
      .animate-float {
        animation: float 6s ease-in-out infinite;
      }
      .animate-pulse-slow {
        animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }
      .sidebar-hover {
        @apply transition-all duration-300 hover:bg-sidebar-hover hover:translate-x-1;
      }
      .card-hover {
        @apply transition-all duration-300 hover:shadow-lg hover:-translate-y-1;
      }
      .sidebar-active {
        @apply bg-sidebar-active font-medium shadow-lg;
      }
      .nav-link-hover {
        @apply transition-all duration-300 hover:bg-primary/10;
      }
    }

    @keyframes float {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
      100% { transform: translateY(0px); }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* 导航栏样式（沿用 index.html） */
    :root {
      --nav-height: 70px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', system-ui, sans-serif;
      background-color: #f8f9fa;
      color: #212529;
      padding-top: var(--nav-height);
    }

    .navbar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: var(--nav-height);
      background: rgba(21, 48, 160, 0.95);
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      display: flex;
      align-items: center;
      padding: 0 2rem;
      transition: var(--transition);
    }

    .navbar.scrolled {
      background: rgba(21, 48, 160, 1);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
    }

    .logo {
      display: flex;
      align-items: center;
      color: white;
      text-decoration: none;
      font-weight: 700;
      font-size: 1.25rem;
      margin-right: 2rem;
    }

    .logo-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      margin-right: 0.7rem;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 50%;
      box-shadow: 0 0 10极 rgba(0, 217, 255, 0.3);
    }

    .nav-links {
      display: flex;
      flex: 1;
    }

    .nav-link {
      position: relative;
      color: rgba(255, 255, 255, 0.85);
      padding: 0.8rem 1.2rem;
      text-decoration: none;
      font-size: 0.95rem;
      transition: var(--transition);
      display: flex;
      align-items: center;
      border-radius: 6px;
      margin: 0 0.2rem;
    }

    .nav-link i {
      margin-right: 0.5rem;
      font-size: 1.1rem;
      transition: var(--transition);
    }

    .nav-link:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }

    .nav-link.active {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      font-weight: 500;
    }

    .nav-link.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 70%;
      height: 3px;
      background: #00d1ff;
      border-radius: 3px 3px 0 0;
    }

    .dropdown {
      position: relative;
    }

    .dropdown-toggle {
      display: flex;
      align-items: center;
      cursor: pointer;
    }

    .dropdown-menu {
      position: absolute;
      top: 100%;
      left: 0;
      width: 220px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      padding: 0.5rem 0;
      opacity: 0;
      visibility: hidden;
      transform: translateY(10px);
      transition: var(--transition);
      z-index: 100;
    }

    .dropdown:hover .dropdown-menu {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .dropdown-item {
      display: block;
      padding: 0.7rem 1.5rem;
      color: #1f2937;
      text-decoration: none;
      transition: var(--极);
      font-size: 0.9rem;
    }

    .dropdown-item:hover {
      background: rgba(22, 93, 255, 0.1);
      color: #165DFF;
    }

    .dropdown-item i {
      margin-right: 0.7rem;
      width: 20px;
      text-align: center;
    }

    .nav-actions {
      display: flex;
      align-items: center;
      margin-left: auto;
    }

    .search-container {
      position: relative;
      margin-right: 1rem;
    }

    .search-input {
      background: rgba(255, 255, 255, 0.15);
      border: none;
      border-radius: 50px;
      padding: 0.6rem 1.2rem 0.6rem 2.5rem;
      color: white;
      font-size: 0.9rem;
      width: 200px;
      transition: var(--transition);
    }

    .search-input:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.25);
      width: 250px;
    }

    .search-input::placeholder {
      color: rgba(255, 255, 255, 0.7);
    }

    .search-icon {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: rgba(255, 255, 255, 0.7);
    }

    .action-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      background: rgba(255, 255, 255, 0.15);
      margin-left: 0.5rem;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
    }

    .action-btn:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: translateY(-2px);
    }

    .notification-badge {
      position: absolute;
      top: -3px;
      right: -3px;
      width: 18px;
      height: 18px;
      background: #ff4d4f;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.65rem;
      color: white;
      font-weight: bold;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      overflow: hidden;
      margin-left: 1rem;
      cursor: pointer;
      border: 2px solid rgba(255, 255, 255, 0.3);
      transition: var(--transition);
      background: #9ca3af;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }

    .user-avatar:hover {
      border-color: #00d1ff;
      transform: scale(1.05);
    }

    .user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .mobile-toggle {
      display: none;
      background: transparent;
      border: none;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
      margin-left: 1rem;
    }

    /* 响应式设计 */
    @media (max-width: 1200px) {
      .nav-link span {
        display: none;
      }

      .nav-link i {
        margin-right: 0;
        font-size: 1.2rem;
      }

      .nav-link {
        padding: 0.8rem;
      }

      .search-input {
        width: 40px;
        padding-left: 40px;
      }

      .search-input:focus {
        width: 200px;
      }
    }

    @media (max-width: 992px) {
      .navbar {
        padding: 0 1rem;
      }

      .nav-links {
        position: fixed;
        top: var(--nav-height);
        left: 0;
        width: 100%;
        background: rgba(21, 48, 160, 0.98);
        flex-direction: column;
        align-items: flex-start;
        padding: 1rem;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        transform: translateY(-100%);
        opacity: 0;
        visibility: hidden;
        transition: var(--transition);
      }

      .nav-links.active {
        transform: translateY(0);
        opacity: 1;
        visibility: visible;
      }

      .nav-link {
        width: 100%;
        margin: 0.3rem 0;
        padding: 0.9rem 1.2rem;
      }

      .nav-link span {
        display: inline;
      }

      .dropdown-menu {
        position: static;
        width: 100%;
        box-shadow: none;
        background: rgba(255, 255, 255, 0.05);
        margin-top: 0.5rem;
        opacity: 1;
        visibility: visible;
        transform: none;
        display: none;
      }

      .dropdown:hover .dropdown-menu {
        display: block;
      }

      .dropdown-item {
        color: rgba(255, 255, 255, 0.85);
        padding-left: 2.5rem;
      }

      .dropdown-item:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
      }

      .mobile-toggle {
        display: block;
      }

      .search-container {
        margin-right: 0.5rem;
      }

      .search-input {
        width: 40px;
        padding-left: 40px;
      }

      .search-input:focus {
        width: 200px;
      }
    }

    body {
      font-family: 'Inter', system-ui, sans-serif;
      background-color: #f8f9fa;
      color: #212529;
      padding-top: var(--nav-height);
    }

    .content {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1.5rem;
    }

    .upload-zone {
      border: 2px dashed #cbd5e1;
      border-radius: 0.75rem;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .upload-zone:hover {
      border-color: #165DFF;
      background-color: rgba(22, 93, 255, 0.05);
    }

    .file-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem;
      background: #f1f5f9;
      border-radius: 0.5rem;
      margin-top: 0.5rem;
    }

    .file-actions {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .custom-button {
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .custom-button.success {
      background: #165DFF;
      color: white;
    }

    .custom-button.success:hover {
      background: #0e42c0;
    }

    .custom-button.danger {
      background: #ef4444;
      color: white;
    }

    .custom-button.danger:hover {
      background: #dc2626;
    }

    .progress-value {
      font-weight: bold;
      margin-bottom: 0.5rem;
      display: block;
    }

    .risk-radar-container {
      margin-top: 2rem;
      height: 300px;
    }

    .ai-report-content {
      background: white;
      padding: 1.5rem;
      border-radius: 0.75rem;
      border: 1px solid #e2e8f0;
      white-space: pre-wrap;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.95rem;
      line-height: 1.5;
      max-height: 400px;
      overflow: auto;
    }

    .evidence-card {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 0.75rem;
      margin-top: 1.5rem;
      padding: 1.25rem 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }

    .evidence-title {
      font-weight: bold;
      color: #1e40af;
      margin-bottom: 0.5rem;
      cursor: pointer;
      user-select: none;
    }

    .evidence-content {
      font-size: 0.97rem;
      color: #333;
      margin-bottom: 0.5rem;
    }

    .evidence-highlight {
      color: #d63384;
      font-weight: bold;
      background: #fff3cd;
      border-radius: 0.3em;
      padding: 0 0.3em;
    }

    .evidence-collapsed {
      display: none;
    }

    .cve-evidence {
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      border-radius: 0.5rem;
      padding: 0.75rem 1rem;
      margin-top: 0.5rem;
      font-size: 0.95rem;
    }

    /* 新增的搜索建议样式 */
    .search-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border-radius: 0 0 10px 10px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }

    .search-suggestions.show {
      display: block;
    }

    .suggestion-item {
      padding: 12px 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      border-bottom: 1px solid #f1f1f1;
      transition: background 0.2s;
    }

    .suggestion-item:hover {
      background: #f5f8ff;
    }

    .suggestion-item i {
      margin-right: 10px;
      width: 20px;
      text-align: center;
      color: #165DFF;
    }

    .suggestion-category {
      font-size: 0.8rem;
      color: #666;
      padding: 8px 16px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: #f9f9f9;
      font-weight: 600;
    }

    .search-hint {
      position: absolute;
      top: 50%;
      right: 15px;
      transform: translateY(-50%);
      font-size: 0.85rem;
      color: #aaa;
      padding: 2px 8px;
      background: rgba(255,255,255,0.5);
      border-radius: 4px;
      pointer-events: none;
      transition: opacity 0.2s;
      opacity: 0;
    }

    .search-hint.show {
      opacity: 1;
    }

    /* 新增的注销菜单样式 */
    .logout-menu {
        position: absolute;
        top: 100%;
        right: 0;
        width: 200px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        padding: 1rem;
        z-index: 1001;
        transform: translateY(10px);
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }

    .logout-menu.active {
        transform: translateY(0);
        opacity: 1;
        visibility: visible;
    }

    .logout-menu p {
        margin-bottom: 10px;
        font-size: 0.9rem;
        color: #555;
    }

    #logoutBtn {
        width: 100%;
        padding: 8px 12px;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.2s;
    }

    #logoutBtn:hover {
        background: #dc2626;
    }
  </style>
</head>
<body class="font-inter bg-gray-50 text-gray-800 min-h-screen flex flex-col">

  <!-- 导航栏（沿用 index.html 的导航栏） -->
  <nav class="navbar">
    <a href="index.html" class="logo">
      <div class="logo-icon">
        <i class="fa fa-bug"></i>
      </div>
      <span>二进制分析平台</span>
    </a>

    <div class="nav-links">
      <a href="index.html" class="nav-link">
        <i class="fa fa-tachometer-alt"></i>
        <span>首页</span>
      </a>

      <div class="dropdown">
        <div class="nav-link">
          <i class="fa fa-copy"></i>
          <span>抄袭检测</span>
        </div>
        <div class="dropdown-menu">
          <a href="analysis-results.html" class="dropdown-item">
            <i class="fa fa-file-text"></i> 分析结果
          </a>
        </div>
      </div>

      <div class="dropdown">
        <div class="nav-link active">
          <i class="fa fa-bug"></i>
          <span>漏洞检测</span>
        </div>
        <div class="dropdown-menu">
          <a href="vulnerable-detection.html" class="dropdown-item">
            <i class="fa fa-search"></i> 漏洞扫描
          </a>
        </div>
      </div>

      <div class="dropdown">
        <div class="nav-link">
          <i class="fa fa-comments"></i>
          <span>漏洞专家问答</span>
        </div>
        <div class="dropdown-menu">
          <a href="knowledge.html" class="dropdown-item">
            <i class="fa fa-question-circle"></i> 漏洞专家问答
          </a>
        </div>
      </div>

      <div class="dropdown">
        <div class="nav-link">
          <i class="fa fa-cog"></i>
          <span>系统管理</span>
        </div>
        <div class="dropdown-menu">
          <a href="settings.html" class="dropdown-item">
            <i class="fa fa-sliders"></i> 系统设置
          </a>
        </div>
      </div>

      <a href="about.html" class="nav-link">
        <i class="fa fa-info-circle"></i>
        <span>关于平台</span>
      </a>
    </div>

    <div class="nav-actions">
      <!-- 更新搜索容器，与index.html一致 -->
      <div class="search-container">
        <i class="fa fa-search search-icon"></i>
        <input type="text" id="searchInput" class="search-input" placeholder="搜索功能或文档..." autocomplete="off">
        <span id="searchHint" class="search-hint">按 Enter 搜索</span>

        <!-- 搜索建议容器 -->
        <div id="searchSuggestions" class="search-suggestions">
          <div class="suggestion-category">常见功能</div>
          <div class="suggestion-item" data-keyword="抄袭检测">
            <i class="fa fa-copy"></i> 抄袭检测
          </div>
          <div class="suggestion-item" data-keyword="漏洞检测">
            <i class="fa fa-bug"></i> 漏洞检测
          </div>
          <div class="suggestion-item" data-keyword="漏洞专家问答">
            <i class="fa fa-comments"></i> 漏洞专家问答
          </div>
          <div class="suggestion-item" data-keyword="系统设置">
            <i class="fa fa-cog"></i> 系统设置
          </div>
        </div>
      </div>

      <!-- 更新用户头像和注销菜单，与index.html一致 -->
      <div class="user-avatar" id="userAvatar">
        <i class="fa fa-user"></i>
      </div>

      <!-- 新增的注销菜单 -->
      <div class="logout-menu" id="logoutMenu">
          <p>当前用户: <span id="currentUser">未登录</span></p>
          <button id="logoutBtn">注销</button>
      </div>

      <button class="mobile-toggle">
        <i class="fa fa-bars"></i>
      </button>
    </div>
  </nav>

  <!-- 主内容区 -->
  <main class="flex-1 transition-all duration-300 pt-[70px]">
    <div class="container mx-auto px-4 py-8">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- 左侧上传区域 -->
        <div class="lg:col-span-1">
          <div class="card bg-white rounded-xl shadow-lg p-6">
            <div class="card-header border-b pb-4 mb-4">
              <h6 class="text-lg font-bold text-primary">漏洞检测</h6>
            </div>
            <div class="card-body">
              <div class="upload-zone" onclick="document.getElementById('vulnFileInput').click()">
                <i class="fas fa-cloud-upload-alt fa-2x mb-3 text-primary"></i>
                <h5 class="font-bold">拖放文件或点击上传</h5>
                <p class="text-sm text-gray-600">支持 EXE/DLL 格式，单文件检测</p>
              </div>
              <input type="file" id="vulnFileInput" accept=".exe,.dll" class="hidden" onchange="handleVulnFiles(this)">
              <div class="mt-4 flex gap-4">
                <button class="custom-button danger" onclick="clearVulnFiles()">
                  <i class="fas fa-trash mr-2"></i>清空
                </button>
                <button class="custom-button success" onclick="startVulnScan()" id="vulnScanBtn">
                  <i class="fas fa-bug mr-2"></i>开始检测
                </button>
              </div>
              <div id="vuln-file-list" class="file-list mt-4"></div>
            </div>
          </div>
        </div>

        <!-- 右侧结果区域 -->
        <div class="lg:col-span-2">
          <div class="card bg-white rounded-xl shadow-lg">
            <div class="card-header bg-red-500 text-white flex justify-between items-center p-4 rounded-t-xl">
              <h5><i class="fas fa-radar"></i> 检测报告</h5>
              <button class="btn bg-white/20 hover:bg-white/30 text-white px-3 py-1 rounded" id="toggleCveBtn" onclick="toggleCveDetail()" disabled>
                <i class="fas fa-list mr-1"></i>查看CVE详情
              </button>
            </div>
            <div class="card-body p-6">
              <div id="vuln-progress-area" class="mb-4">
                <div class="progress-value" id="vuln-progress-value">0%</div>
                <div class="w-full bg-gray-200 rounded-full h-2.5 mb-2">
                  <div class="bg-primary h-2.5 rounded-full" style="width: 0%" id="vuln-progress-bar"></div>
                </div>
                <div class="text-sm text-gray-600" id="vuln-progress-status">等待检测</div>
              </div>

              <div class="risk-radar-container">
                <canvas id="riskRadarChart" class="w-full h-64"></canvas>
              </div>

              <div class="mt-4">
                <h6 class="text-lg font-semibold mb-2">
                  <i class="fas fa-robot mr-2"></i>AI分析报告
                </h6>
                <pre id="vuln-ai-report" class="ai-report-content bg-gray-50 p-4 rounded-lg">请上传文件并点击“开始检测”</pre>

                <!-- 溯源证据卡片 -->
                <div class="evidence-card">
                  <div class="evidence-title" onclick="toggleEvidence('main-evidence')">
                    <i class="fas fa-search-location mr-2"></i> 溯源证据
                    <span id="main-evidence-toggle" class="ml-2">[展开]</span>
                  </div>
                  <div class="evidence-content evidence-collapsed" id="main-evidence">
                    <div id="evidence-dangerous-apis"></div>
                    <div id="evidence-key-instructions"></div>
                    <div id="evidence-cfg"></div>
                    <div id="evidence-disasm"></div>
                  </div>
                </div>
              </div>

              <!-- CVE详情折叠区块 -->
              <div class="mt-4 hidden" id="cve-detail-area">
                <h6 class="text-lg font-semibold mb-2">
                  <i class="fas fa-bug mr-2"></i>CVE详情
                </h6>
                <div id="cve-list-area"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- 修复建议弹出框 -->
  <div id="repairModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4">
      <div class="flex justify-between items-center p-4 border-b">
        <h5 class="text-lg font-semibold">修复建议</h5>
        <span class="text-gray-500 hover:text-gray-700 cursor-pointer" onclick="closeModal()">&times;</span>
      </div>
      <div class="p-4" id="repairContent">
        <!-- 修复内容将在这里动态加载 -->
      </div>
      <div class="flex justify-end p-4 border-t">
        <button type="button" class="btn bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded" onclick="closeModal()">关闭</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // 文件上传与列表
    let vulnSelectedFile = null;
    function handleVulnFiles(input) {
      if (input.files.length > 1) {
        alert('只支持单文件检测');
        input.value = '';
        return;
      }
      vulnSelectedFile = input.files[0];
      renderVulnFileList();
    }

    function renderVulnFileList() {
      const container = document.getElementById('vuln-file-list');
      if (vulnSelectedFile) {
        container.innerHTML = `
          <div class="file-item">
            <span>${vulnSelectedFile.name}</span>
            <div class="file-actions">
              <span class="text-gray-500">${(vulnSelectedFile.size/1024).toFixed(1)}KB</span>
              <button class="ml-2 text-red-500 hover:text-red-700" onclick="clearVulnFiles()">×</button>
            </div>
          </div>
        `;
      } else {
        container.innerHTML = '';
      }
    }

    function clearVulnFiles() {
      vulnSelectedFile = null;
      document.getElementById('vulnFileInput').value = '';
      renderVulnFileList();
    }

    // 风险分布雷达图
    let riskRadarChart;
    function initRiskRadarChart(data) {
      const ctx = document.getElementById('riskRadarChart').getContext('2d');
      if (riskRadarChart) riskRadarChart.destroy();
      riskRadarChart = new Chart(ctx, {
        type: 'radar',
        data: {
          labels: ['危险API', '内存操作', '控制流复杂度', '危险调用'],
          datasets: [{
            label: '风险分布',
            data: data || [0,0,0,0],
            backgroundColor: 'rgba(22, 93, 255, 0.2)',
            borderColor: 'rgba(22, 93, 255, 1)',
            borderWidth: 2,
            pointBackgroundColor: 'rgba(22, 93, 255, 1)',
            pointRadius: 4
          }]
        },
        options: {
          scales: {
            r: {
              beginAtZero: true,
              max: 10,
              ticks: { stepSize: 2, backdropColor: 'transparent' },
              grid: { color: 'rgba(0,0,0,0.05)' },
              pointLabels: { font: { size: 12 } }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) { return `${context.label}: ${context.raw}`; }
              }
            }
          },
          animation: { duration: 2000 }
        }
      });
    }

    // 检测进度动画
    function animateVulnProgress(targetValue) {
      const progressBar = document.getElementById('vuln-progress-bar');
      const progressValue = document.getElementById('vuln-progress-value');
      let current = 0;
      const duration = 1200, interval = 15, steps = duration/interval, increment = targetValue/steps;
      const timer = setInterval(() => {
        current += increment;
        if (current >= targetValue) { current = targetValue; clearInterval(timer); }
        progressBar.style.width = `${current}%`;
        progressValue.textContent = `${Math.round(current)}%`;
      }, interval);
    }

    // 启动检测
    async function startVulnScan() {
      if (!vulnSelectedFile) {
        alert('请先选择一个文件');
        return;
      }
      const btn = document.getElementById('vulnScanBtn');
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>检测中...';
      document.getElementById('vuln-progress-status').textContent = '正在上传并分析...';
      animateVulnProgress(60);
      document.getElementById('toggleCveBtn').disabled = true;
      try {
        const apiKey = localStorage.getItem('modelApiKey');
        const modelType = localStorage.getItem('modelType');
        const formData = new FormData();
        formData.append('file', vulnSelectedFile);
        const headers = {};
        if (apiKey) headers['Authorization'] = `Bearer ${apiKey}`;
        if (modelType) headers['Model-Type'] = modelType;
        const response = await fetch('/vuln_scan', {
          method: 'POST',
          body: formData,
          headers: headers
        });
        const result = await response.json();
        if (!response.ok) throw new Error(result.error || '检测失败');

        initRiskRadarChart(result.radar_data);
        document.getElementById('vuln-ai-report').textContent = result.ai_report;
        animateVulnProgress(100);
        document.getElementById('vuln-progress-status').textContent = '检测完成';
        renderCveList((result.features && result.features.cve_list) ? result.features.cve_list : []);
        document.getElementById('toggleCveBtn').disabled = false;
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-bug mr-2"></i>开始检测';
        renderEvidence(result.features || {});
      } catch (error) {
        alert('检测出错: ' + error.message);
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-bug mr-2"></i>开始检测';
        document.getElementById('vuln-progress-status').textContent = '检测失败';
      }
    }

    function toggleCveDetail() {
      const area = document.getElementById('cve-detail-area');
      area.classList.toggle('hidden');
    }

    function renderCveList(cveList) {
      const cveListArea = document.getElementById('cve-list-area');
      if (!cveList || !Array.isArray(cveList) || !cveList.length) {
        cveListArea.innerHTML = '<div class="bg-blue-50 p-4 rounded-lg">未检测到CVE相关漏洞。</div>';
        return;
      }
      cveListArea.innerHTML = cveList.map(cve => `
        <div class="bg-white border rounded-lg p-4 mb-3">
          <div class="flex items-center mb-2">
            <i class="fas fa-bug text-red-500 mr-2"></i>
            <strong>${cve.cve_id || '未知CVE'}</strong>
            <span class="bg-gray-200 text-gray-800 px-2 py-1 rounded-full text-xs ml-2">${cve.type || '未知类型'}</span>
          </div>
          <div class="mb-2"><strong>描述：</strong>${cve.description || '无详细描述'}</div>
          <div class="mb-2"><strong>修复建议：</strong>${cve.repair || '暂无建议'}</div>
          <div><strong>外部链接：</strong>${cve.link ? `<a href="${cve.link}" target="_blank" class="text-blue-600 hover:underline">${cve.link}</a>` : '无'}</div>
          <div class="mt-2 p-3 bg-gray-50 rounded">
            <strong>检测依据：</strong><br>
            危险API：${cve.dangerous_apis ? cve.dangerous_apis.map(api=>`<span class='evidence-highlight'>${api}</span>`).join(', ') : '无'}<br>
            关键指令：${cve.key_instructions ? cve.key_instructions.map(addr=>`<span class='evidence-highlight'>${addr}</span>`).join(', ') : '无'}<br>
            CFG复杂度：${cve.cfg_complexity || '未知'}
          </div>
        </div>
      `).join('');
    }

    function renderEvidence(features) {
      const apis = features && features.dangerous_apis ? features.dangerous_apis : [];
      document.getElementById('evidence-dangerous-apis').innerHTML =
        `<div><strong>危险API调用：</strong> ${apis.length ? apis.map(api => `<span class='evidence-highlight'>${api}</span>`).join(', ') : '无'}</div>`;

      const keyInstr = features && features.key_instructions ? features.key_instructions : [];
      document.getElementById('evidence-key-instructions').innerHTML =
        `<div><strong>关键指令地址：</strong> ${keyInstr.length ? keyInstr.map(addr => `<span class='evidence-highlight'>${addr}</span>`).join(', ') : '无'}</div>`;

      document.getElementById('evidence-cfg').innerHTML =
        `<div><strong>控制流复杂度：</strong> ${features && features.cfg_complexity ? features.cfg_complexity : '未知'}</div>`;

      document.getElementById('evidence-disasm').innerHTML =
        `<div><strong>反汇编片段：</strong><pre class='bg-gray-50 p-3 rounded'>${features && features.raw_disasm ? features.raw_disasm.split('\n').slice(0,10).join('\n') + (features.raw_disasm.split('\n').length>10?'...':'') : '无'}</pre></div>`;
    }

    function toggleEvidence(id) {
      const content = document.getElementById(id);
      const toggle = document.getElementById(id+'-toggle');
      if (content.classList.contains('evidence-collapsed')) {
        content.classList.remove('evidence-collapsed');
        if(toggle) toggle.textContent = '[收起]';
      } else {
        content.classList.add('evidence-collapsed');
        if(toggle) toggle.textContent = '[展开]';
      }
    }

    function closeModal() {
      document.getElementById('repairModal').classList.add('hidden');
    }

    // 初始化
    document.addEventListener('DOMContentLoaded', function() {
      initRiskRadarChart([0,0,0,0]);
      renderVulnFileList();

      // 检查登录状态
      const storedUser = localStorage.getItem('loggedInUser');
      if (storedUser) {
        document.getElementById('userAvatar').innerHTML = storedUser.charAt(0).toUpperCase();
        document.getElementById('userAvatar').style.backgroundColor = '#7B61FF';
        document.getElementById('userAvatar').style.color = 'white';
        document.getElementById('userAvatar').style.fontWeight = 'bold';
        document.getElementById('currentUser').textContent = storedUser;
      }
    });

    // 从index.html复制的搜索功能代码
    const searchInput = document.getElementById('searchInput');
    const searchSuggestions = document.getElementById('searchSuggestions');
    const searchHint = document.getElementById('searchHint');
    let suggestionItems = document.querySelectorAll('.suggestion-item');

    // 搜索关键词与页面的映射
    const searchMappings = {
      '抄袭检测': 'analysis-results.html',
      '抄袭分析': 'analysis-results.html',
      '抄袭': 'analysis-results.html',
      '同源分析': 'analysis-results.html',
      '重复代码': 'analysis-results.html',
      '漏洞检测': 'vulnerable-detection.html',
      '漏洞扫描': 'vulnerable-detection.html',
      '安全扫描': 'vulnerable-detection.html',
      '漏洞查找': 'vulnerable-detection.html',
      '漏洞专家问答': 'knowledge.html',
      '专家问答': 'knowledge.html',
      '漏洞知识库': 'knowledge.html',
      '问答': 'knowledge.html',
      '系统设置': 'settings.html',
      '设置': 'settings.html',
      '配置': 'settings.html',
      '安全设置': 'settings.html'
    };

    // 输入事件监听
    searchInput.addEventListener('input', function() {
      const query = this.value.trim().toLowerCase();

      if (query.length > 0) {
        searchHint.classList.add('show');
        searchSuggestions.classList.add('show');
      } else {
        searchHint.classList.remove('show');
        searchSuggestions.classList.remove('show');
      }
    });

    // 回车搜索事件
    searchInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        performSearch(this.value);
      }
    });

    // 失去焦点隐藏建议
    searchInput.addEventListener('blur', function() {
      setTimeout(() => {
        searchSuggestions.classList.remove('show');
        searchHint.classList.remove('show');
      }, 200);
    });

    // 点击搜索建议项
    suggestionItems.forEach(item => {
      item.addEventListener('mousedown', function() {
        const keyword = this.getAttribute('data-keyword');
        searchInput.value = keyword;
        performSearch(keyword);
      });
    });

    // 执行搜索逻辑
    function performSearch(query) {
      const keyword = query.trim();
      const targetPage = findMatchingPage(keyword);

      if (targetPage) {
        window.location.href = targetPage;
      } else {
        showNotification(`未找到与"${keyword}"匹配的功能，尝试其他关键词`, 'error');
      }
    }

    // 查找匹配的页面
    function findMatchingPage(query) {
      const normalizedQuery = query.toLowerCase();

      // 查找完全匹配的关键词
      if (searchMappings[normalizedQuery]) {
        return searchMappings[normalizedQuery];
      }

      // 查找部分匹配的关键词
      for (const keyword in searchMappings) {
        if (normalizedQuery.includes(keyword.toLowerCase())) {
          return searchMappings[keyword];
        }
      }

      return null;
    }

    // 从index.html复制的登录状态管理代码
    const userAvatar = document.getElementById('userAvatar');
    const logoutMenu = document.getElementById('logoutMenu');
    const logoutBtn = document.getElementById('logoutBtn');
    const currentUser = document.getElementById('currentUser');

    // 显示登录界面
    userAvatar.addEventListener('click', () => {
      const loggedInUser = localStorage.getItem('loggedInUser');
      if (loggedInUser) {
        // 显示注销菜单
        logoutMenu.classList.toggle('active');
      } else {
        window.location.href = 'index.html';
      }
    });

    // 点击页面其他位置关闭注销菜单
    document.addEventListener('click', (e) => {
      if (!userAvatar.contains(e.target) && !logoutMenu.contains(e.target)) {
        logoutMenu.classList.remove('active');
      }
    });

    // 注销功能
    logoutBtn.addEventListener('click', () => {
      localStorage.removeItem('loggedInUser');
      userAvatar.innerHTML = '<i class="fa fa-user"></i>';
      userAvatar.style.backgroundColor = '';
      userAvatar.style.color = '';
      userAvatar.style.fontWeight = '';
      logoutMenu.classList.remove('active');
      showNotification('您已成功注销');
      location.reload();
    });

    // 显示通知函数
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.classList.add('fixed', 'top-4', 'right-4', 'px-6', 'py-4', 'rounded-lg', 'shadow-lg', 'z-50', 'animate-slide-in');

      if (type === 'error') {
        notification.classList.add('bg-red-100', 'text-red-800');
      } else {
        notification.classList.add('bg-white', 'text-gray-800');
      }

      notification.textContent = message;

      const closeBtn = document.createElement('button');
      closeBtn.innerHTML = '<i class="fa fa-times"></i>';
      closeBtn.classList.add('absolute', 'top-2', 'right-2', 'text-gray-500', 'hover:text-gray-700');
      closeBtn.addEventListener('click', () => {
        notification.remove();
      });

      notification.appendChild(closeBtn);
      document.body.appendChild(notification);

      // 自动消失
      setTimeout(() => {
        notification.classList.add('animate-slide-out');
        setTimeout(() => {
          notification.remove();
        }, 300);
      }, 3000);
    }

    // 添加动画关键帧
    const style = document.createElement('style');
    style.innerHTML = `
      @keyframes slide-in {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes slide-out {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }

      .animate-slide-in {
        animation: slide-in 0.3s ease-out forwards;
      }

      .animate-slide-out {
        animation: slide-out 0.3s ease-in forwards;
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>
